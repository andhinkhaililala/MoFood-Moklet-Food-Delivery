<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MoFood â€” Moklet Food Delivery (Demo)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --primary:#e23b3b;
    --accent:#ff6b6b;
    --bg:#f6f7fb;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#111827;
    --border:#e5e7eb;
    --success:#16a34a;
    --danger:#dc2626;
    --warning:#f59e0b;
    --shadow: 0 10px 25px rgba(0,0,0,0.06);
  }

  *{box-sizing:border-box}
  body{
    font-family:Inter,system-ui,Arial;
    margin:0;
    background:var(--bg);
    color:var(--text);
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px 20px;
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.9);
    backdrop-filter: blur(8px);
    position:sticky;
    top:0;
    z-index:50;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .logo{
    width:46px;
    height:46px;
    border-radius:14px;
    background:linear-gradient(135deg,var(--primary),var(--accent));
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:800;
    font-size:16px;
    box-shadow:0 10px 20px rgba(226,59,59,0.25);
  }

  h1{
    margin:0;
    font-size:16px;
    letter-spacing:0.2px;
  }

  .sub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }

  header .right{
    display:flex;
    gap:10px;
    align-items:center;
  }

  .container{
    max-width:1200px;
    margin:18px auto;
    padding:14px;
  }

  .grid{
    display:grid;
    grid-template-columns:350px 1fr;
    gap:16px;
  }

  .card{
    background:var(--card);
    border-radius:18px;
    padding:14px;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
  }

  .card h3{
    margin:0;
    font-size:16px;
  }

  .muted{
    color:var(--muted);
    font-size:13px;
  }

  input,select,button,textarea{
    font-family:inherit;
  }

  input,select,textarea{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    width:100%;
    outline:none;
    background:#fff;
  }

  input:focus,select:focus,textarea:focus{
    border-color:rgba(226,59,59,0.6);
    box-shadow:0 0 0 4px rgba(226,59,59,0.12);
  }

  button{
    background:var(--primary);
    color:#fff;
    border:0;
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    transition:0.2s;
  }

  button:hover{
    transform:translateY(-1px);
    filter:brightness(0.95);
  }

  button:disabled{
    background:#d1d5db;
    cursor:not-allowed;
    transform:none;
  }

  .outline{
    background:transparent;
    border:1px solid var(--border);
    color:var(--primary);
  }

  .outline:hover{
    background:rgba(226,59,59,0.06);
  }

  .kantin-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }

  .kantin-item{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    border-radius:16px;
    border:1px solid var(--border);
    cursor:pointer;
    transition:0.2s;
    background:#fff;
  }

  .kantin-item:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 25px rgba(0,0,0,0.06);
  }

  .kantin-color{
    width:50px;
    height:50px;
    border-radius:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:800;
    font-size:14px;
  }

  .searchRow{
    display:flex;
    gap:10px;
    margin-top:12px;
  }

  .menu-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
    gap:14px;
    margin-top:14px;
  }

  .menu-card{
    border-radius:18px;
    overflow:hidden;
    border:1px solid var(--border);
    background:#fff;
    display:flex;
    flex-direction:column;
    transition:0.2s;
  }

  .menu-card:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 25px rgba(0,0,0,0.08);
  }

  .menu-card img{
    width:100%;
    height:140px;
    object-fit:cover;
  }

  .menu-body{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .menu-name{
    font-weight:700;
    font-size:14px;
  }

  .price{
    font-weight:800;
    color:var(--primary);
  }

  .tagRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }

  .badge{
    font-size:12px;
    padding:5px 10px;
    border-radius:999px;
    font-weight:700;
    display:inline-block;
  }

  .badge-ready{
    background:#dcfce7;
    color:#166534;
  }

  .badge-habis{
    background:#fee2e2;
    color:#991b1b;
  }

  .badge-type{
    background:#eff6ff;
    color:#1d4ed8;
  }

  .cart{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }

  .cart-item{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
  }

  .cart-actions{
    display:flex;
    gap:6px;
    align-items:center;
    justify-content:flex-end;
  }

  .cart-actions button{
    padding:6px 10px;
    border-radius:10px;
    font-size:12px;
  }

  .small{font-size:12px}

  .orders-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }

  .toast{
    position:fixed;
    right:18px;
    bottom:18px;
    background:#fff;
    border-radius:16px;
    padding:12px 14px;
    box-shadow:0 12px 30px rgba(0,0,0,0.15);
    z-index:999;
    border:1px solid var(--border);
    font-weight:600;
  }

  .hidden{display:none}

  footer{
    margin-top:18px;
    text-align:center;
    color:var(--muted);
    font-size:13px;
    padding:14px;
  }

  .hero{
    display:flex;
    gap:12px;
    margin-top:12px;
    flex-wrap:wrap;
  }

  .heroBox{
    flex:1;
    min-width:240px;
    border-radius:18px;
    border:1px solid var(--border);
    padding:14px;
    background:linear-gradient(180deg,#fff,#fafafa);
  }

  .heroBox h4{
    margin:0;
    font-size:14px;
  }

  .heroBox ol{
    margin:10px 0 0 18px;
    padding:0;
  }

  .heroBox li{
    margin:6px 0;
  }

  .totalBox{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px;
    border-radius:14px;
    border:1px dashed rgba(226,59,59,0.35);
    background:rgba(226,59,59,0.04);
    margin-top:12px;
  }

  .totalBox strong{
    font-size:14px;
  }

  .seller-panel .menu-edit{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }

  @media (max-width:950px){
    .grid{grid-template-columns:1fr}
    .kantin-list{flex-direction:row;overflow:auto;padding-bottom:6px}
    .kantin-item{min-width:240px}
  }
</style>
</head>

<body>

<header>
  <div class="brand">
    <div class="logo">MF</div>
    <div>
      <h1>MoFood â€” Moklet Food Delivery</h1>
      <div class="sub">Pesan cepat â€¢ Kantin rapi â€¢ Tracking realtime (Demo)</div>
    </div>
  </div>

  <div class="right">
    <div id="who" class="muted">Belum login</div>
    <div id="actionBtns"></div>
  </div>
</header>

<div class="container">

  <!-- AUTH -->
  <div id="authCard" class="card">
    <h3>Masuk / Daftar</h3>
    <div class="muted">Masukkan nama & password. Jika belum ada akun, otomatis dibuat.</div>

    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
      <select id="roleSelect" style="max-width:240px">
        <option value="pembeli">Pembeli (Siswa/Guru)</option>
        <option value="penjual">Penjual (Kantin)</option>
      </select>
      <input id="nameInp" placeholder="Nama (contoh: Andin / Kantin A)" />
      <input id="passInp" type="password" placeholder="Password" />
      <button id="loginBtn">Login / Register</button>
    </div>

    <div class="muted small" style="margin-top:10px">
      Demo password rekomendasi: <strong>123</strong>
    </div>
  </div>

  <!-- MAIN -->
  <div id="mainApp" class="hidden">
    <div class="grid">

      <!-- LEFT -->
      <div>
        <div class="card">
          <h3>Pilih Kantin</h3>
          <div class="muted small">12 Kantin Moklet (dengan menu masing-masing)</div>

          <div class="searchRow">
            <input id="searchKantin" placeholder="Cari kantin / menu..." />
            <button class="outline" onclick="renderKantinList()">Cari</button>
          </div>

          <div id="kantinList" class="kantin-list"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Keranjang</h3>
          <div class="muted small">Pesanan kamu akan otomatis dipisah per kantin saat checkout.</div>

          <div id="cartBox" class="cart muted small">Keranjang kosong</div>

          <div id="cartTotal" class="totalBox hidden">
            <strong>Total</strong>
            <div class="price" id="totalPrice">Rp 0</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px">
            <input id="kelasInp" placeholder="Kelas (jika diantar)" />
            <select id="deliveryOpt">
              <option value="ambil">Ambil Sendiri</option>
              <option value="antar">Minta Diantar</option>
            </select>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
            <button class="outline" onclick="clearCart()">Bersihkan</button>
            <button onclick="checkout()">Checkout</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Riwayat Pesanan</h3>
          <div id="buyerOrders" class="orders-list muted small">Belum ada pesanan</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div id="placeContent" class="card">

          <!-- WELCOME -->
          <div id="welcomeArea">
            <h3>Selamat Datang di MoFood ðŸ‘‹</h3>
            <div class="muted">Pilih kantin untuk melihat menu. Login sebagai penjual untuk kelola menu & pesanan.</div>

            <div class="hero">
              <div class="heroBox">
                <h4>âœ¨ Cara Pesan</h4>
                <ol class="muted small">
                  <li>Pilih kantin</li>
                  <li>Pilih menu favorit</li>
                  <li>Checkout + pilih ambil / antar</li>
                  <li>Lacak status pesanan</li>
                </ol>
              </div>

              <div class="heroBox">
                <h4>ðŸ“Œ Fitur Utama</h4>
                <ul class="muted small" style="margin:10px 0 0 18px">
                  <li>Menu tiap kantin berbeda</li>
                  <li>Keranjang otomatis per kantin</li>
                  <li>Status pesanan realtime</li>
                  <li>Panel penjual lengkap</li>
                </ul>
              </div>

              <div class="heroBox">
                <h4>ðŸ’³ Pembayaran</h4>
                <div class="muted small" style="margin-top:10px">
                  Pembayaran bisa melalui <strong>Cash</strong> atau <strong>QRIS (simulasi)</strong>.
                </div>
              </div>
            </div>
          </div>

          <!-- MENU -->
          <div id="menuArea" class="hidden">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
              <div>
                <h3 id="kantinTitle">Kantin</h3>
                <div id="kantinInfo" class="muted small">Daftar menu</div>
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <input id="searchMenu" placeholder="Cari menu di kantin ini..." style="min-width:240px" oninput="renderMenu(currentKantinId)">
                <select id="menuFilter" onchange="renderMenu(currentKantinId)">
                  <option value="">Semua</option>
                  <option value="makanan">Makanan</option>
                  <option value="minuman">Minuman</option>
                  <option value="snack">Snack</option>
                </select>
              </div>
            </div>

            <div id="menuGrid" class="menu-grid"></div>
          </div>

          <!-- SELLER -->
          <div id="sellerArea" class="hidden seller-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div>
                <h3>Panel Penjual â€” <span id="sellerName">Kantin</span></h3>
                <div class="muted small">Kelola menu & pesanan masuk</div>
              </div>
              <button onclick="logout()">Logout</button>
            </div>

            <div style="margin-top:14px;display:flex;gap:14px;flex-wrap:wrap">
              <div style="flex:1;min-width:320px">
                <h4 style="margin:0">Tambah Menu</h4>

                <div class="menu-edit">
                  <input id="foodName" placeholder="Nama menu" />
                  <input id="foodPrice" placeholder="Harga" type="number" />
                  <select id="foodType">
                    <option value="makanan">Makanan</option>
                    <option value="minuman">Minuman</option>
                    <option value="snack">Snack</option>
                  </select>
                  <select id="foodStatus">
                    <option value="ready">Ready</option>
                    <option value="habis">Habis</option>
                  </select>
                  <input id="foodImage" type="file" accept="image/*" />
                  <button onclick="addMenu()">Tambah</button>
                </div>

                <div style="margin-top:16px">
                  <h4 style="margin:0">Daftar Menu Kantin</h4>
                  <div id="myMenus" class="menu-grid"></div>
                </div>
              </div>

              <div style="width:380px;min-width:300px">
                <h4 style="margin:0">Pesanan Masuk</h4>
                <div id="incomingOrders" class="orders-list muted small">Belum ada pesanan</div>

                <h4 style="margin-top:16px;margin-bottom:0">Riwayat Penjualan</h4>
                <div id="sellerOrders" class="orders-list muted small">Belum ada riwayat</div>
              </div>
            </div>
          </div>

        </div>

        <footer>MoFood Demo â€” data tersimpan di browser (localStorage). Untuk produksi: gunakan server + database.</footer>
      </div>

    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* MoFood â€” improved UI + full kantin menu seed */

const DB = {
  users: 'mofood_users_v2',
  kantins: 'mofood_kantins_v2',
  menus: 'mofood_menus_v2',
  orders: 'mofood_orders_v2'
}

const $ = id => document.getElementById(id)
const toastEl = $('toast')

function toast(msg, timeout=3200){
  toastEl.textContent = msg
  toastEl.classList.remove('hidden')
  setTimeout(()=>toastEl.classList.add('hidden'), timeout)
}

function dbGet(key){ return JSON.parse(localStorage.getItem(key) || '[]') }
function dbSet(key,val){ localStorage.setItem(key, JSON.stringify(val)) }

// ----------------- SEED KANTIN
function seedKantins(){
  if(dbGet(DB.kantins).length>0) return

  const kantins = [
    { id:'k1', name:'Kantin A - Nasi & Lauk', color:'#e23b3b', desc:'Menu berat + lauk lengkap' },
    { id:'k2', name:'Kantin B - Jajan Ringan', color:'#ff6b6b', desc:'Snack & jajan favorit anak Moklet' },
    { id:'k3', name:'Kantin C - Minuman Dingin', color:'#f97316', desc:'Es, susu, teh, dan minuman segar' },
    { id:'k4', name:'Kantin D - Bakso', color:'#fb7185', desc:'Bakso komplit + mie ayam' },
    { id:'k5', name:'Kantin E - Mie & Soto', color:'#f59e0b', desc:'Soto ayam, mie, dan nasi kuning' },
    { id:'k6', name:'Kantin F - Gorengan', color:'#22c55e', desc:'Gorengan hangat tiap hari' },
    { id:'k7', name:'Kantin G - Snack & Roti', color:'#3b82f6', desc:'Roti, donat, snack manis' },
    { id:'k8', name:'Kantin H - Juice Bar', color:'#06b6d4', desc:'Jus buah segar + smoothies' },
    { id:'k9', name:'Kantin I - Sayur & Salad', color:'#16a34a', desc:'Menu sehat, salad, sayur fresh' },
    { id:'k10', name:'Kantin J - Special Rice', color:'#8b5cf6', desc:'Rice bowl + ayam crispy' },
    { id:'k11', name:'Kantin K - Dessert', color:'#ec4899', desc:'Dessert manis, puding, es krim' },
    { id:'k12', name:'Kantin L - Kopi & Camilan', color:'#0f172a', desc:'Kopi susu + camilan' }
  ]

  dbSet(DB.kantins, kantins)
}

// ----------------- SEED MENUS (SETIAP KANTIN ADA MENU)
function seedMenus(){
  if(dbGet(DB.menus).length>0) return

  const menus = [
    // Kantin A
    {id:'m1', kantin:'k1', name:'Nasi Goreng Spesial', price:12000, status:'ready', type:'makanan', img:''},
    {id:'m2', kantin:'k1', name:'Ayam Geprek', price:13000, status:'ready', type:'makanan', img:''},
    {id:'m3', kantin:'k1', name:'Es Teh Manis', price:4000, status:'ready', type:'minuman', img:''},

    // Kantin B
    {id:'m4', kantin:'k2', name:'Cilok Pedas', price:7000, status:'ready', type:'snack', img:''},
    {id:'m5', kantin:'k2', name:'Sosis Bakar', price:8000, status:'ready', type:'snack', img:''},
    {id:'m6', kantin:'k2', name:'Pentol Mercon', price:9000, status:'ready', type:'snack', img:''},

    // Kantin C
    {id:'m7', kantin:'k3', name:'Es Jeruk', price:6000, status:'ready', type:'minuman', img:''},
    {id:'m8', kantin:'k3', name:'Es Coklat', price:8000, status:'ready', type:'minuman', img:''},
    {id:'m9', kantin:'k3', name:'Susu Strawberry', price:9000, status:'ready', type:'minuman', img:''},

    // Kantin D
    {id:'m10', kantin:'k4', name:'Bakso Komplit', price:15000, status:'ready', type:'makanan', img:''},
    {id:'m11', kantin:'k4', name:'Mie Ayam Bakso', price:14000, status:'ready', type:'makanan', img:''},
    {id:'m12', kantin:'k4', name:'Es Teh', price:4000, status:'ready', type:'minuman', img:''},

    // Kantin E
    {id:'m13', kantin:'k5', name:'Soto Ayam', price:12000, status:'ready', type:'makanan', img:''},
    {id:'m14', kantin:'k5', name:'Mie Goreng Jawa', price:11000, status:'ready', type:'makanan', img:''},
    {id:'m15', kantin:'k5', name:'Teh Hangat', price:3000, status:'ready', type:'minuman', img:''},

    // Kantin F
    {id:'m16', kantin:'k6', name:'Pisang Goreng', price:5000, status:'ready', type:'snack', img:''},
    {id:'m17', kantin:'k6', name:'Tahu Isi', price:4000, status:'ready', type:'snack', img:''},
    {id:'m18', kantin:'k6', name:'Bakwan', price:3000, status:'ready', type:'snack', img:''},

    // Kantin G
    {id:'m19', kantin:'k7', name:'Roti Coklat', price:7000, status:'ready', type:'snack', img:''},
    {id:'m20', kantin:'k7', name:'Donat Gula', price:6000, status:'ready', type:'snack', img:''},
    {id:'m21', kantin:'k7', name:'Milkshake Vanilla', price:10000, status:'ready', type:'minuman', img:''},

    // Kantin H
    {id:'m22', kantin:'k8', name:'Jus Alpukat', price:12000, status:'ready', type:'minuman', img:''},
    {id:'m23', kantin:'k8', name:'Jus Mangga', price:10000, status:'ready', type:'minuman', img:''},
    {id:'m24', kantin:'k8', name:'Smoothie Strawberry', price:13000, status:'ready', type:'minuman', img:''},

    // Kantin I
    {id:'m25', kantin:'k9', name:'Salad Buah', price:12000, status:'ready', type:'makanan', img:''},
    {id:'m26', kantin:'k9', name:'Salad Sayur', price:11000, status:'ready', type:'makanan', img:''},
    {id:'m27', kantin:'k9', name:'Air Mineral', price:3000, status:'ready', type:'minuman', img:''},

    // Kantin J
    {id:'m28', kantin:'k10', name:'Rice Bowl Ayam Crispy', price:15000, status:'ready', type:'makanan', img:''},
    {id:'m29', kantin:'k10', name:'Rice Bowl Teriyaki', price:16000, status:'ready', type:'makanan', img:''},
    {id:'m30', kantin:'k10', name:'Es Lemon Tea', price:7000, status:'ready', type:'minuman', img:''},

    // Kantin K
    {id:'m31', kantin:'k11', name:'Puding Coklat', price:6000, status:'ready', type:'snack', img:''},
    {id:'m32', kantin:'k11', name:'Es Krim Cup', price:8000, status:'ready', type:'snack', img:''},
    {id:'m33', kantin:'k11', name:'Brownies Mini', price:9000, status:'ready', type:'snack', img:''},

    // Kantin L
    {id:'m34', kantin:'k12', name:'Kopi Susu', price:8000, status:'ready', type:'minuman', img:''},
    {id:'m35', kantin:'k12', name:'Teh Tarik', price:9000, status:'ready', type:'minuman', img:''},
    {id:'m36', kantin:'k12', name:'Kentang Goreng', price:10000, status:'ready', type:'snack', img:''}
  ]

  dbSet(DB.menus, menus)
}

// ----------------- SEED USERS
function seedUsers(){
  if(dbGet(DB.users).length>0) return

  const users = [
    {id:'seller_k1', name:'Kantin A', role:'penjual', pass:'123', kantinId:'k1'},
    {id:'seller_k2', name:'Kantin B', role:'penjual', pass:'123', kantinId:'k2'},
    {id:'seller_k3', name:'Kantin C', role:'penjual', pass:'123', kantinId:'k3'},
    {id:'seller_k4', name:'Kantin D', role:'penjual', pass:'123', kantinId:'k4'},
    {id:'seller_k5', name:'Kantin E', role:'penjual', pass:'123', kantinId:'k5'},
    {id:'seller_k6', name:'Kantin F', role:'penjual', pass:'123', kantinId:'k6'},
    {id:'seller_k7', name:'Kantin G', role:'penjual', pass:'123', kantinId:'k7'},
    {id:'seller_k8', name:'Kantin H', role:'penjual', pass:'123', kantinId:'k8'},
    {id:'seller_k9', name:'Kantin I', role:'penjual', pass:'123', kantinId:'k9'},
    {id:'seller_k10', name:'Kantin J', role:'penjual', pass:'123', kantinId:'k10'},
    {id:'seller_k11', name:'Kantin K', role:'penjual', pass:'123', kantinId:'k11'},
    {id:'seller_k12', name:'Kantin L', role:'penjual', pass:'123', kantinId:'k12'},
    {id:'demo_buyer', name:'Demo Siswa', role:'pembeli', pass:'123'}
  ]

  dbSet(DB.users, users)
}

// orders
function seedOrders(){
  if(!localStorage.getItem(DB.orders)) dbSet(DB.orders, [])
}

// run seeds
seedKantins()
seedMenus()
seedUsers()
seedOrders()

// ----------------- STATE
let currentUser = null
let currentKantinId = null
let cart = []
let sellerChecker = null
let lastPendingCount = 0

// UI refs
const authCard = $('authCard')
const mainApp = $('mainApp')
const whoEl = $('who')
const actionBtns = $('actionBtns')
const kantinListEl = $('kantinList')
const menuArea = $('menuArea')
const menuGrid = $('menuGrid')
const kantinTitle = $('kantinTitle')
const kantinInfo = $('kantinInfo')
const welcomeArea = $('welcomeArea')
const sellerArea = $('sellerArea')
const sellerNameEl = $('sellerName')
const incomingOrdersEl = $('incomingOrders')
const sellerOrdersEl = $('sellerOrders')
const cartBox = $('cartBox')
const buyerOrdersEl = $('buyerOrders')

// ----------------- AUTH
$('loginBtn').addEventListener('click', ()=>{
  const role = $('roleSelect').value
  const name = $('nameInp').value.trim()
  const pass = $('passInp').value

  if(!name || !pass){
    alert('Isi nama & password')
    return
  }

  const users = dbGet(DB.users)
  let user = users.find(u=>u.name.toLowerCase()===name.toLowerCase() && u.role===role)

  if(!user){
    const id = role==='penjual'?('seller_'+name.toLowerCase().replace(/\s+/g,'_')):('buyer_'+Date.now())
    user = {id,name,role,pass}

    if(role==='penjual'){
      const kantins = dbGet(DB.kantins)
      user.kantinId = kantins[0].id
    }

    users.push(user)
    dbSet(DB.users, users)
    toast('Akun baru berhasil dibuat!')
  } else {
    if(user.pass !== pass){
      alert('Password salah!')
      return
    }
  }

  currentUser = user
  postLogin()
})

function postLogin(){
  authCard.classList.add('hidden')
  mainApp.classList.remove('hidden')
  whoEl.textContent = `${currentUser.name} (${currentUser.role})`

  actionBtns.innerHTML = ''
  const logoutBtn = document.createElement('button')
  logoutBtn.textContent = 'Logout'
  logoutBtn.onclick = logout
  actionBtns.appendChild(logoutBtn)

  renderKantinList()

  if(currentUser.role === 'penjual'){
    openSellerPanel()
  } else {
    showWelcome()
  }

  renderBuyerOrders()
}

function logout(){
  currentUser = null
  cart = []
  stopSellerChecker()

  authCard.classList.remove('hidden')
  mainApp.classList.add('hidden')
  whoEl.textContent = 'Belum login'
}

// ----------------- KANTIN LIST
function renderKantinList(){
  const kantins = dbGet(DB.kantins)
  const q = $('searchKantin').value.trim().toLowerCase()

  kantinListEl.innerHTML = ''

  kantins
    .filter(k=>k.name.toLowerCase().includes(q) || k.desc.toLowerCase().includes(q))
    .forEach(k=>{
      const el = document.createElement('div')
      el.className = 'kantin-item'
      el.onclick = ()=>openKantin(k.id)

      el.innerHTML = `
        <div class="kantin-color" style="background:${k.color}">
          ${k.name.split(' ')[1] || 'K'}
        </div>
        <div style="flex:1">
          <div style="font-weight:800">${k.name}</div>
          <div class="muted small">${k.desc}</div>
        </div>
        <div class="muted small">Menu â†’</div>
      `
      kantinListEl.appendChild(el)
    })
}

// ----------------- OPEN MENU
function openKantin(kid){
  currentKantinId = kid
  welcomeArea.classList.add('hidden')
  sellerArea.classList.add('hidden')
  menuArea.classList.remove('hidden')

  const kantin = dbGet(DB.kantins).find(k=>k.id===kid)
  kantinTitle.textContent = kantin.name
  kantinInfo.textContent = kantin.desc

  $('searchMenu').value = ''
  $('menuFilter').value = ''
  renderMenu(kid)
}

// ----------------- MENU RENDER
function renderMenu(kid){
  const menus = dbGet(DB.menus).filter(m=>m.kantin===kid)

  const q = $('searchMenu').value.trim().toLowerCase()
  const filter = $('menuFilter').value

  let list = menus
  if(q) list = list.filter(m=>m.name.toLowerCase().includes(q))
  if(filter) list = list.filter(m=>m.type===filter)

  menuGrid.innerHTML = ''

  if(list.length===0){
    menuGrid.innerHTML = `<div class="muted">Menu tidak ditemukan.</div>`
    return
  }

  list.forEach(m=>{
    const card = document.createElement('div')
    card.className = 'menu-card'

    card.innerHTML = `
      ${m.img
        ? `<img src="${m.img}">`
        : `<div style="height:140px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#6b7280;font-weight:700">
            No Image
          </div>`
      }

      <div class="menu-body">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
          <div class="menu-name">${m.name}</div>
          <div class="price">Rp ${m.price.toLocaleString()}</div>
        </div>

        <div class="tagRow">
          <span class="badge badge-type">${m.type}</span>
          ${m.status==='ready'
            ? `<span class="badge badge-ready">READY</span>`
            : `<span class="badge badge-habis">HABIS</span>`
          }
        </div>

        <div style="display:flex;justify-content:flex-end">
          <button ${m.status==='habis'?'disabled':''} onclick="addToCart('${m.id}')">
            + Tambah
          </button>
        </div>
      </div>
    `
    menuGrid.appendChild(card)
  })
}

// ----------------- CART
function addToCart(menuId){
  const menus = dbGet(DB.menus)
  const item = menus.find(m=>m.id===menuId)

  if(!item || item.status==='habis'){
    alert('Menu tidak tersedia')
    return
  }

  const ex = cart.find(c=>c.id===item.id)
  if(ex) ex.qty++
  else cart.push({id:item.id,kantin:item.kantin,name:item.name,price:item.price,qty:1})

  renderCart()
  toast('Ditambahkan: ' + item.name)
}

function renderCart(){
  const totalBox = $('cartTotal')
  const totalPrice = $('totalPrice')

  if(cart.length===0){
    cartBox.innerHTML = 'Keranjang kosong'
    totalBox.classList.add('hidden')
    return
  }

  cartBox.innerHTML = ''
  let total = 0

  cart.forEach((c,i)=>{
    total += c.price * c.qty

    const el = document.createElement('div')
    el.className = 'cart-item'
    el.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:800">${c.name}</div>
        <div class="muted small">x${c.qty} â€¢ Kantin: ${c.kantin}</div>
      </div>

      <div style="text-align:right">
        <div style="font-weight:900">Rp ${(c.price*c.qty).toLocaleString()}</div>
        <div class="cart-actions">
          <button class="outline" onclick="decQty(${i})">-</button>
          <button class="outline" onclick="incQty(${i})">+</button>
          <button style="background:var(--danger)" onclick="removeItem(${i})">Hapus</button>
        </div>
      </div>
    `
    cartBox.appendChild(el)
  })

  totalBox.classList.remove('hidden')
  totalPrice.textContent = "Rp " + total.toLocaleString()
}

function incQty(i){ cart[i].qty++; renderCart() }
function decQty(i){ if(cart[i].qty>1) cart[i].qty--; else cart.splice(i,1); renderCart() }
function removeItem(i){ cart.splice(i,1); renderCart() }

function clearCart(){
  if(confirm('Kosongkan keranjang?')){
    cart=[]
    renderCart()
  }
}

// ----------------- CHECKOUT
function checkout(){
  if(cart.length===0){
    alert('Keranjang kosong')
    return
  }
  if(!currentUser || currentUser.role!=='pembeli'){
    alert('Login sebagai pembeli dulu')
    return
  }

  const delivery = $('deliveryOpt').value
  const kelas = $('kelasInp').value.trim()

  if(delivery==='antar' && !kelas){
    alert('Isi kelas tujuan jika ingin diantar')
    return
  }

  const menus = dbGet(DB.menus)
  const byKantin = {}

  cart.forEach(c=>{
    const m = menus.find(x=>x.id===c.id)
    if(!m) return
    if(!byKantin[m.kantin]) byKantin[m.kantin] = []
    byKantin[m.kantin].push({...c})
  })

  const orders = dbGet(DB.orders)

  Object.keys(byKantin).forEach(kid=>{
    const id = 'O' + Date.now() + Math.floor(Math.random()*900)
    const items = byKantin[kid]
    const total = items.reduce((s,i)=>s+(i.price*i.qty),0)

    orders.push({
      id,
      kantin:kid,
      buyerId: currentUser.id,
      buyerName: currentUser.name,
      items,
      total,
      delivery,
      kelas: delivery==='antar'?kelas:'',
      payMethod:null,
      status:'pending',
      createdAt:new Date().toISOString(),
      logs:[{t:new Date().toISOString(), text:'Pesanan dibuat'}]
    })
  })

  dbSet(DB.orders, orders)
  cart=[]
  renderCart()
  renderBuyerOrders()
  toast('Checkout sukses! Pesanan dikirim ke kantin.')
}

// ----------------- BUYER ORDERS
function renderBuyerOrders(){
  if(!currentUser || currentUser.role!=='pembeli'){
    buyerOrdersEl.innerHTML = `<div class="muted">Login sebagai pembeli untuk melihat riwayat.</div>`
    return
  }

  const orders = dbGet(DB.orders)
    .filter(o=>o.buyerId===currentUser.id)
    .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))

  if(orders.length===0){
    buyerOrdersEl.innerHTML = `<div class="muted">Belum ada pesanan</div>`
    return
  }

  buyerOrdersEl.innerHTML = ''

  orders.forEach(o=>{
    const el = document.createElement('div')
    el.className = 'card'
    el.style.padding = '12px'

    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:900">${o.id}</div>
          <div class="muted small">${new Date(o.createdAt).toLocaleString()}</div>
        </div>

        <div style="text-align:right">
          <div class="price">Rp ${o.total.toLocaleString()}</div>
          <div class="muted small">
            Kantin: ${o.kantin} â€¢ ${o.delivery==='antar' ? 'Diantar ke '+o.kelas : 'Ambil sendiri'}
          </div>
        </div>
      </div>

      <div class="muted small" style="margin-top:10px">
        <strong>Items:</strong> ${o.items.map(i=>i.name+' x'+i.qty).join(', ')}
      </div>

      <div style="margin-top:10px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center">
        <div class="muted small">Status: <strong>${o.status}</strong></div>
        <button class="outline" onclick="showPayment('${o.id}')">Bayar</button>
      </div>
    `
    buyerOrdersEl.appendChild(el)
  })
}

// ----------------- PAYMENT
function showPayment(orderId){
  const orders = dbGet(DB.orders)
  const o = orders.find(x=>x.id===orderId)
  if(!o) return

  const pay = prompt('Metode bayar? ketik: cash / qr')
  if(!pay) return

  if(pay.toLowerCase()==='cash'){
    o.payMethod = 'cash'
    o.logs.push({t:new Date().toISOString(), text:'Pembayaran dipilih: CASH'})
    toast('Pembayaran CASH dipilih.')
  } else {
    o.payMethod = 'qr'
    o.logs.push({t:new Date().toISOString(), text:'Pembayaran dipilih: QRIS'})
    alert('Simulasi QRIS: Anggap sudah dibayar.')
    toast('Pembayaran QRIS berhasil (simulasi).')
  }

  dbSet(DB.orders, orders)
  renderBuyerOrders()
}

// ----------------- SELLER PANEL
function openSellerPanel(){
  const kantin = dbGet(DB.kantins).find(k=>k.id===currentUser.kantinId)
  sellerNameEl.textContent = kantin ? kantin.name : 'Kantin'

  welcomeArea.classList.add('hidden')
  menuArea.classList.add('hidden')
  sellerArea.classList.remove('hidden')

  renderMyMenus()
  renderSellerOrders()
  startSellerChecker()
}

function addMenu(){
  const name = $('foodName').value.trim()
  const price = Number($('foodPrice').value)
  const type = $('foodType').value
  const status = $('foodStatus').value
  const file = $('foodImage').files[0]

  if(!name || !price){
    alert('Isi nama & harga!')
    return
  }

  const menus = dbGet(DB.menus)
  const id = 'm_' + Date.now()

  if(file){
    const reader = new FileReader()
    reader.onload = e=>{
      menus.push({id,kantin:currentUser.kantinId,name,price,status,type,img:e.target.result})
      dbSet(DB.menus, menus)
      toast('Menu berhasil ditambahkan!')
      $('foodName').value=''
      $('foodPrice').value=''
      $('foodImage').value=''
      renderMyMenus()
    }
    reader.readAsDataURL(file)
  } else {
    menus.push({id,kantin:currentUser.kantinId,name,price,status,type,img:''})
    dbSet(DB.menus, menus)
    toast('Menu berhasil ditambahkan!')
    $('foodName').value=''
    $('foodPrice').value=''
    renderMyMenus()
  }
}

function renderMyMenus(){
  const menus = dbGet(DB.menus).filter(m=>m.kantin===currentUser.kantinId)
  const el = $('myMenus')
  el.innerHTML=''

  if(menus.length===0){
    el.innerHTML = `<div class="muted">Belum ada menu.</div>`
    return
  }

  menus.forEach(m=>{
    const card = document.createElement('div')
    card.className = 'menu-card'
    card.innerHTML = `
      ${m.img
        ? `<img src="${m.img}">`
        : `<div style="height:140px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#6b7280;font-weight:700">
            No Image
          </div>`
      }

      <div class="menu-body">
        <div style="display:flex;justify-content:space-between;gap:10px">
          <div class="menu-name">${m.name}</div>
          <div class="price">Rp ${m.price.toLocaleString()}</div>
        </div>

        <div class="tagRow">
          <span class="badge badge-type">${m.type}</span>
          ${m.status==='ready'
            ? `<span class="badge badge-ready">READY</span>`
            : `<span class="badge badge-habis">HABIS</span>`
          }
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="outline" onclick="toggleMenuStatus('${m.id}')">Toggle</button>
          <button style="background:var(--danger)" onclick="deleteMenu('${m.id}')">Hapus</button>
        </div>
      </div>
    `
    el.appendChild(card)
  })
}

function toggleMenuStatus(id){
  const menus = dbGet(DB.menus)
  const m = menus.find(x=>x.id===id)
  if(!m) return
  m.status = m.status==='ready'?'habis':'ready'
  dbSet(DB.menus, menus)
  toast('Status menu diubah.')
  renderMyMenus()
}

function deleteMenu(id){
  if(!confirm('Hapus menu ini?')) return
  let menus = dbGet(DB.menus)
  menus = menus.filter(x=>x.id!==id)
  dbSet(DB.menus, menus)
  toast('Menu dihapus.')
  renderMyMenus()
}

// ----------------- SELLER ORDERS
function renderSellerOrders(){
  const orders = dbGet(DB.orders)

  const incoming = orders
    .filter(o=>o.kantin===currentUser.kantinId && o.status!=='done')
    .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))

  const history = orders
    .filter(o=>o.kantin===currentUser.kantinId && o.status==='done')

  incomingOrdersEl.innerHTML = ''
  sellerOrdersEl.innerHTML = ''

  if(incoming.length===0){
    incomingOrdersEl.innerHTML = `<div class="muted">Belum ada pesanan masuk.</div>`
  }

  incoming.forEach(o=>{
    const el = document.createElement('div')
    el.className = 'card'
    el.style.padding = '12px'

    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:900">${o.id}</div>
          <div class="muted small">${o.buyerName} â€¢ ${new Date(o.createdAt).toLocaleString()}</div>
        </div>

        <div style="text-align:right">
          <div class="price">Rp ${o.total.toLocaleString()}</div>
          <div class="muted small">${o.delivery==='antar'?'Antar ke '+o.kelas:'Ambil sendiri'}</div>
        </div>
      </div>

      <div class="muted small" style="margin-top:10px">
        <strong>Items:</strong> ${o.items.map(i=>i.name+' x'+i.qty).join(', ')}
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button onclick="changeOrderStatus('${o.id}','accepted')">Terima</button>
        <button onclick="changeOrderStatus('${o.id}','preparing')">Dimasak</button>
        <button onclick="changeOrderStatus('${o.id}','ready')">Siap</button>
        <button onclick="changeOrderStatus('${o.id}','ondelivery')">Diantar</button>
        <button style="background:var(--success)" onclick="changeOrderStatus('${o.id}','done')">Selesai</button>
      </div>
    `
    incomingOrdersEl.appendChild(el)
  })

  if(history.length===0){
    sellerOrdersEl.innerHTML = `<div class="muted">Belum ada riwayat penjualan.</div>`
  } else {
    history.slice(-10).reverse().forEach(h=>{
      const el = document.createElement('div')
      el.className = 'card'
      el.style.padding = '10px'
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px">
          <div><strong>${h.id}</strong></div>
          <div class="price">Rp ${h.total.toLocaleString()}</div>
        </div>
        <div class="muted small">${h.buyerName} â€¢ ${new Date(h.createdAt).toLocaleString()}</div>
      `
      sellerOrdersEl.appendChild(el)
    })
  }
}

function changeOrderStatus(orderId,newStatus){
  const orders = dbGet(DB.orders)
  const o = orders.find(x=>x.id===orderId)
  if(!o) return

  o.status = newStatus
  o.logs.push({t:new Date().toISOString(), text:'Status diubah: '+newStatus})

  dbSet(DB.orders, orders)
  toast('Status pesanan diupdate: ' + newStatus)

  renderSellerOrders()
  renderBuyerOrders()
}

// seller checker
function startSellerChecker(){
  stopSellerChecker()
  sellerChecker = setInterval(()=>{
    const orders = dbGet(DB.orders)
    const pending = orders.filter(o=>o.kantin===currentUser.kantinId && o.status==='pending')

    if(pending.length > lastPendingCount){
      toast('Ada pesanan baru masuk!')
    }

    lastPendingCount = pending.length
    renderSellerOrders()
  }, 2500)
}

function stopSellerChecker(){
  if(sellerChecker) clearInterval(sellerChecker)
  sellerChecker = null
  lastPendingCount = 0
}

// ----------------- WELCOME
function showWelcome(){
  welcomeArea.classList.remove('hidden')
  menuArea.classList.add('hidden')
  sellerArea.classList.add('hidden')
}

// expose
window.renderKantinList = renderKantinList
window.openKantin = openKantin
window.renderMenu = renderMenu
window.addToCart = addToCart
window.checkout = checkout
window.clearCart = clearCart
window.incQty = incQty
window.decQty = decQty
window.removeItem = removeItem
window.showPayment = showPayment
window.logout = logout
window.addMenu = addMenu
window.toggleMenuStatus = toggleMenuStatus
window.deleteMenu = deleteMenu
window.changeOrderStatus = changeOrderStatus
</script>

</body>
</html>
